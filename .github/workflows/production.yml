name: Revert Specified Files on PR to Master

on:
  pull_request:
    branches:
      - master
env:
  base_ref: ${{ github.base_ref != '' && github.base_ref || 'master' }}

jobs:
  revert-specified-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch origin ${{ env.base_ref }}
        run: git fetch origin ${{ env.base_ref }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Read ignored files from JSON
        id: read_json
        run: |
            files=$(jq -c '.files[]' ignoredToMergeIntoMaster.json)
            echo "files=$files" >> $GITHUB_ENV

      - name: Check for changes in specified files
        id: check_changes
        run: |
          changes_detected=false
          for item in ${{ env.files }}; do
            file=$(echo $item | jq -r '.file')
            path=$(echo $item | jq -r '.path')
            full_path="$path/$file"
            if git diff origin/${{ env.base_ref }} --name-only | grep -q "$full_path"; then
              changes_detected=true
              break
            fi
          done
          echo "changes_detected=$changes_detected" >> $GITHUB_ENV

      - name: Revert changes in specified files
        if: env.changes_detected == 'true'
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          for item in ${{ env.files }}; do
            file=$(echo $item | jq -r '.file')
            path=$(echo $item | jq -r '.path')
            full_path="$path/$file"
            if git diff origin/${{ env.base_ref }} --name-only | grep -q "$full_path"; then
              git checkout origin/${{ env.base_ref }} -- "$full_path"
            fi
          done
          git commit -am "Revert changes in specified files"
          git push origin HEAD:${{ github.event.pull_request.head.ref }} -f

      - name: Continue if no changes in specified files
        if: env.changes_detected == 'false'
        run: echo "No changes in specified files, proceeding with the workflow."